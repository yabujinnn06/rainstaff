<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rainstaff Admin Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body class="admin">
    <header class="topbar">
      <div class="brand">
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Menu">Menu</button>
        <div>
          <div class="brand-title">Rainstaff Admin</div>
          <div class="brand-sub">Yonetim Paneli</div>
        </div>
      </div>
      <div class="sync">
        <span class="status {{ 'ok' if desktop_online else 'off' }}">
          Masaustu {{ 'Acik' if desktop_online else 'Kapali' }}
        </span>
        <span class="alert-pill">Uyari {{ alert_counts.total }}</span>
        Son senkron: {{ last_sync or 'Yok' }}
        <span class="hint">Manuel senkron masaustu uygulamadan yapilir</span>
        <a class="logout" href="/logout">Cikis</a>
      </div>
    </header>
    <div class="backdrop" id="sidebarBackdrop"></div>

    <div class="layout">
      <aside class="sidebar">
        <div class="menu-title">Genel</div>
        <a href="#overview">Ozet</a>
        <a href="#alerts">Uyarilar</a>
        <a href="#employees">Calisanlar</a>
        <a href="#overtime">Fazla Mesai</a>
        <a href="#timesheets">Puantaj</a>
        <div class="menu-title">Araclar</div>
        <a href="#faults">Acik Arizalar</a>
        <a href="#service">Sanayi</a>
        <a href="/reports">Haftalik Raporlar</a>
        <a href="#vehicles">Arac Kartlari</a>
        <a href="#drivers">Suruculer</a>
        <a href="#inspections">Kontroller</a>
      </aside>

      <main class="content">
        <section id="overview" class="section">
          <div class="section-title">Genel Ozet</div>
          <div class="kpi-grid">
            <div class="card">
              <div class="label">Calisan</div>
              <div class="value">{{ summary.employees }}</div>
            </div>
            <div class="card">
              <div class="label">Puantaj Kaydi</div>
              <div class="value">{{ summary.timesheets }}</div>
            </div>
            <div class="card">
              <div class="label">Arac</div>
              <div class="value">{{ summary.vehicles }}</div>
            </div>
            <div class="card">
              <div class="label">Surucu</div>
              <div class="value">{{ summary.drivers }}</div>
            </div>
            <div class="card warn">
              <div class="label">Acik Ariza</div>
              <div class="value">{{ summary.open_faults }}</div>
            </div>
            <div class="card warn">
              <div class="label">Sanayide</div>
              <div class="value">{{ summary.service_open }}</div>
            </div>
            <div class="card">
              <div class="label">Toplam Calisilan Saat</div>
              <div class="value">{{ summary.worked_hours }}</div>
            </div>
            <div class="card warn">
              <div class="label">Toplam Fazla Mesai</div>
              <div class="value">{{ summary.overtime_hours }}</div>
            </div>
            <div class="card">
              <div class="label">Toplam Gece</div>
              <div class="value">{{ summary.night_hours }}</div>
            </div>
            <div class="card">
              <div class="label">Toplam Ozel Gun</div>
              <div class="value">{{ summary.special_hours }}</div>
            </div>
          </div>
        </section>

        <section class="section filter-bar">
          <div class="panel-head">
            <h2>Filtre</h2>
          </div>
          <form method="get" class="filter-form">
            <label>Baslangic</label>
            <input type="date" name="start" value="{{ start_date }}" />
            <label>Bitis</label>
            <input type="date" name="end" value="{{ end_date }}" />
            <label class="check">
              <input type="checkbox" name="all" value="1" {% if all_months %}checked{% endif %} />
              Tum Aylar
            </label>
            <button type="submit">Uygula</button>
          </form>
          <div class="range-cards">
            <div class="mini-card">
              <div class="label">Secili Aralik Calisilan</div>
              <div class="value">{{ range_summary.worked }}</div>
            </div>
            <div class="mini-card warn">
              <div class="label">Secili Aralik Fazla Mesai</div>
              <div class="value">{{ range_summary.overtime }}</div>
            </div>
            <div class="mini-card">
              <div class="label">Secili Aralik Gece</div>
              <div class="value">{{ range_summary.night }}</div>
            </div>
            <div class="mini-card">
              <div class="label">Secili Aralik Ozel Gun</div>
              <div class="value">{{ range_summary.special }}</div>
            </div>
          </div>
        </section>

        <section id="alerts" class="section panel">
          <div class="panel-head">
            <h2>Haftalik Kontrol Uyarilari</h2>
            <div class="alert-stats">
              <span class="badge bad">Kotulesti: {{ alert_counts.bad }}</span>
              <span class="badge repeat">Tekrar: {{ alert_counts.repeat }}</span>
              <span class="badge good">Duzeldi: {{ alert_counts.good }}</span>
            </div>
          </div>
          <div class="table-wrap tall">
            <table id="alert-table">
              <thead>
                <tr>
                  <th>Plaka</th>
                  <th>Hafta</th>
                  <th>Kontrol</th>
                  <th>Onceki</th>
                  <th>Bu Hafta</th>
                  <th>Durum</th>
                </tr>
              </thead>
              <tbody>
                {% if weekly_alerts %}
                  {% for row in weekly_alerts %}
                    <tr class="alert-row {{ row['level'] }}">
                      <td>{{ row['plate'] }}</td>
                      <td>{{ row['week_start'] }}</td>
                      <td>{{ row['item'] }}</td>
                      <td>{{ row['prev_status'] }}</td>
                      <td>{{ row['current_status'] }}</td>
                      <td>{{ row['change'] }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="6">Kayit yok</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </section>

        <section class="section grid-2">
          <div class="panel">
            <div class="panel-head">
              <h2>Aylik Ozet</h2>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Ay</th>
                    <th>Calisilan</th>
                    <th>Fazla Mesai</th>
                    <th>Gece</th>
                    <th>Ozel Gun</th>
                  </tr>
                </thead>
                <tbody>
                  {% if monthly_summary %}
                    {% for row in monthly_summary %}
                      <tr>
                        <td>{{ row['month'] }}</td>
                        <td>{{ row['worked'] }}</td>
                        <td>{{ row['overtime'] }}</td>
                        <td>{{ row['night'] }}</td>
                        <td>{{ row['special'] }}</td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="5">Kayit yok</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="panel">
            <div class="panel-head">
              <h2>Gunluk Ozet (Secili Aralik)</h2>
            </div>
            <div class="table-wrap tall">
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Calisilan</th>
                    <th>Fazla Mesai</th>
                    <th>Gece</th>
                    <th>Ozel Gun</th>
                  </tr>
                </thead>
                <tbody>
                  {% if daily_summary %}
                    {% for row in daily_summary %}
                      <tr>
                        <td>{{ row['date'] }}</td>
                        <td>{{ row['worked'] }}</td>
                        <td>{{ row['overtime'] }}</td>
                        <td>{{ row['night'] }}</td>
                        <td>{{ row['special'] }}</td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="5">Kayit yok</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </section>


        <section class="section grid-2">
          <div id="faults" class="panel">
            <div class="panel-head">
              <h2>Acik Arizalar</h2>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Plaka</th>
                    <th>Baslik</th>
                    <th>Acilis</th>
                  </tr>
                </thead>
                <tbody>
                  {% if open_faults %}
                    {% for row in open_faults %}
                      <tr>
                        <td>{{ row['plate'] }}</td>
                        <td>{{ row['title'] }}</td>
                        <td>{{ row['opened_date'] or '-' }}</td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="3">Kayit yok</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>

          <div id="service" class="panel">
            <div class="panel-head">
              <h2>Sanayide Olan Araclar</h2>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Plaka</th>
                    <th>Gidis</th>
                    <th>Neden</th>
                  </tr>
                </thead>
                <tbody>
                  {% if service_open %}
                    {% for row in service_open %}
                      <tr>
                        <td>{{ row['plate'] }}</td>
                        <td>{{ row['start_date'] }}</td>
                        <td>{{ row['reason'] or '-' }}</td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="3">Kayit yok</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="employees" class="section panel">
          <div class="panel-head">
            <h2>Calisan Kartlari</h2>
            <input class="table-search" data-target="employee-table" placeholder="Calisan ara..." />
          </div>
          <div class="table-wrap tall">
            <table id="employee-table">
              <thead>
                <tr>
                  <th>Calisan</th>
                  <th>Toplam Gun</th>
                  <th>Calisilan Saat</th>
                  <th>Fazla Mesai</th>
                  <th>Gece</th>
                  <th>Ozel Gun</th>
                </tr>
              </thead>
              <tbody>
                {% if employee_cards %}
                {% for row in employee_cards %}
                  <tr>
                    <td><a class="link" href="/employee/{{ row['id'] }}">{{ row['name'] }}</a></td>
                    <td>{{ row['days'] }}</td>
                    <td>{{ row['worked']|round(2) }}</td>
                    <td>{{ row['overtime']|round(2) }}</td>
                    <td>{{ row['night']|round(2) }}</td>
                    <td>{{ row['special']|round(2) }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="6">Kayit yok</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </section>

        <section id="overtime" class="section grid-2">
          <div class="panel">
            <div class="panel-head">
              <h2>Fazla Mesai Liderleri</h2>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Calisan</th>
                    <th>Fazla Mesai</th>
                  </tr>
                </thead>
                <tbody>
                  {% if overtime_leaders %}
                    {% for row in overtime_leaders %}
                      <tr>
                        <td>{{ row['name'] }}</td>
                        <td>{{ row['overtime']|round(2) }}</td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="2">Kayit yok</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="panel">
            <div class="panel-head">
              <h2>En Cok Ariza Yapan Araclar</h2>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Plaka</th>
                    <th>Ariza Adet</th>
                  </tr>
                </thead>
                <tbody>
                  {% if top_faults %}
                    {% for row in top_faults %}
                      <tr>
                        <td>{{ row['plate'] }}</td>
                        <td>{{ row['cnt'] }}</td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="2">Kayit yok</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="timesheets" class="section panel">
          <div class="panel-head">
            <h2>Son Puantaj Kayitlari</h2>
            <input class="table-search" data-target="timesheet-table" placeholder="Puantaj ara..." />
          </div>
          <div class="table-wrap tall">
            <table id="timesheet-table">
              <thead>
                <tr>
                  <th>Calisan</th>
                  <th>Tarih</th>
                  <th>Giris</th>
                  <th>Cikis</th>
                  <th>Mola</th>
                  <th>Ozel Gun</th>
                </tr>
              </thead>
              <tbody>
                {% if recent_timesheets %}
                  {% for row in recent_timesheets %}
                    <tr>
                      <td>{{ row['name'] }}</td>
                      <td>{{ row['work_date'] }}</td>
                      <td>{{ row['start_time'] }}</td>
                      <td>{{ row['end_time'] }}</td>
                      <td>{{ row['break_minutes'] }}</td>
                      <td>{{ 'Evet' if row['is_special'] else 'Hayir' }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="6">Kayit yok</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </section>

        <section class="section grid-2">
          <div id="vehicles" class="panel">
            <div class="panel-head">
              <h2>Arac Kartlari</h2>
              <input class="table-search" data-target="vehicle-table" placeholder="Plaka ara..." />
            </div>
            <div class="table-wrap">
              <table id="vehicle-table">
                <thead>
                  <tr>
                    <th>Plaka</th>
                    <th>KM</th>
                    <th>Muayene</th>
                    <th>Sigorta</th>
                    <th>Bakim</th>
                    <th>Acik Ariza</th>
                    <th>Sanayide</th>
                  </tr>
                </thead>
                <tbody>
                  {% if vehicle_cards %}
                    {% for row in vehicle_cards %}
                      <tr>
                        <td>{{ row['plate'] }}</td>
                        <td>{{ row['km'] or '-' }}</td>
                        <td>{{ row['inspection_date'] or '-' }}</td>
                        <td>{{ row['insurance_date'] or '-' }}</td>
                        <td>{{ row['maintenance_date'] or '-' }}</td>
                        <td>{{ row['open_fault'] or '-' }}</td>
                        <td>{{ row['in_service'] or '-' }}</td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="7">Kayit yok</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>

          <div id="drivers" class="panel">
            <div class="panel-head">
              <h2>Surucu Kartlari</h2>
              <input class="table-search" data-target="driver-table" placeholder="Surucu ara..." />
            </div>
            <div class="table-wrap">
              <table id="driver-table">
                <thead>
                  <tr>
                    <th>Surucu</th>
                    <th>Ehliyet</th>
                    <th>Bitis</th>
                    <th>Telefon</th>
                  </tr>
                </thead>
                <tbody>
                  {% if driver_cards %}
                    {% for row in driver_cards %}
                      <tr>
                        <td>{{ row['name'] }}</td>
                        <td>{{ row['license_class'] or '-' }}</td>
                        <td>{{ row['license_expiry'] or '-' }}</td>
                        <td>{{ row['phone'] or '-' }}</td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="4">Kayit yok</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="inspections" class="section panel">
          <div class="panel-head">
            <h2>Son Kontroller</h2>
            <input class="table-search" data-target="inspection-table" placeholder="Kontrol ara..." />
          </div>
          <div class="table-wrap">
            <table id="inspection-table">
              <thead>
                <tr>
                  <th>Plaka</th>
                  <th>Tarih</th>
                  <th>Hafta</th>
                  <th>Surucu</th>
                  <th>KM</th>
                  <th>Ariza Durum</th>
                  <th>Sanayi</th>
                </tr>
              </thead>
              <tbody>
                {% if recent_inspections %}
                  {% for row in recent_inspections %}
                    <tr>
                      <td>{{ row['plate'] }}</td>
                      <td>{{ row['inspection_date'] }}</td>
                      <td>{{ row['week_start'] }}</td>
                      <td>{{ row['driver'] or '-' }}</td>
                      <td>{{ row['km'] or '-' }}</td>
                      <td>{{ row['fault_status'] or '-' }}</td>
                      <td>{{ 'Evet' if row['service_visit'] else 'Hayir' }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="7">Kayit yok</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <script>
      const sidebarToggle = document.getElementById("sidebarToggle");
      const sidebarBackdrop = document.getElementById("sidebarBackdrop");
      const toggleSidebar = () => document.body.classList.toggle("sidebar-open");
      if (sidebarToggle) {
        sidebarToggle.addEventListener("click", toggleSidebar);
      }
      if (sidebarBackdrop) {
        sidebarBackdrop.addEventListener("click", () => {
          document.body.classList.remove("sidebar-open");
        });
      }
      const allToggle = document.querySelector('input[name="all"]');
      const startInput = document.querySelector('input[name="start"]');
      const endInput = document.querySelector('input[name="end"]');
      if (allToggle && startInput && endInput) {
        const toggleDates = () => {
          const disabled = allToggle.checked;
          startInput.disabled = disabled;
          endInput.disabled = disabled;
        };
        allToggle.addEventListener("change", toggleDates);
        toggleDates();
      }
      document.querySelectorAll(".table-search").forEach((input) => {
        input.addEventListener("input", () => {
          const targetId = input.getAttribute("data-target");
          const table = document.getElementById(targetId);
          if (!table) return;
          const needle = input.value.toLowerCase();
          table.querySelectorAll("tbody tr").forEach((row) => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(needle) ? "" : "none";
          });
        });
      });
    </script>
  </body>
</html>
