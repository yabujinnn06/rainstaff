78906o{% extends "base.html" %}

{% block title %}Rainstaff ERP - Dashboard{% endblock %}

{% block content %}
<div class="header">
    <div class="logo">
        <h1 style="font-size: 24px; font-weight: bold; letter-spacing: 3px;">
            RAIN
        </h1>
    </div>
    <div class="user-info">
        <div class="user-badge">
            <span>{{ user['username'] }}</span> | <span>{{ user['region'] }}</span>
        </div>
        <!-- Premium Control Panel Buttons -->
        <div class="control-panel">
            <button id="theme-toggle" onclick="toggleTheme()" class="ctrl-btn ctrl-theme" title="Tema Değiştir">
                <span class="ctrl-icon">◐</span>
                <span class="ctrl-label">TEMA</span>
            </button>
            <a href="/logout" class="ctrl-btn ctrl-logout" title="Sistemden Çık">
                <span class="ctrl-icon">⏻</span>
                <span class="ctrl-label">ÇIKIŞ</span>
            </a>
        </div>
    </div>
</div>

<div class="nav-container">
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('overview')">GENEL BAKIŞ</button>
        <button class="nav-tab" onclick="showTab('employees')">ÇALIŞANLAR</button>
        <button class="nav-tab" onclick="showTab('timesheets')">PUANTAJ</button>
        <button class="nav-tab" onclick="showTab('stock')">STOK</button>
        <button class="nav-tab" onclick="showTab('vehicles')">ARAÇLAR</button>
        <button class="nav-tab" onclick="showTab('reports')">RAPORLAR</button>
    </div>
</div>

<div class="container">
    <!-- OVERVIEW TAB -->
    <div id="overview" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Toplam Çalışan</h3>
                <div class="value" id="total-employees">{{ employees|length }}</div>
            </div>
            <div class="stat-card">
                <h3>Toplam Puantaj</h3>
                <div class="value" id="total-timesheets">{{ timesheets|length }}</div>
            </div>
            <div class="stat-card">
                <h3>Stok Kalemleri</h3>
                <div class="value" id="total-stock">-</div>
            </div>
            <div class="stat-card">
                <h3>Aktif Bölgeler</h3>
                <div class="value">4</div>
            </div>
        </div>

        <div class="card">
            <h2>>>> SİSTEM DURUMU</h2>
            <div style="padding: 20px;">
                <p style="margin-bottom: 10px;">✓ Veritabanı: <span style="color: var(--matrix-green);">AKTIF</span></p>
                <p style="margin-bottom: 10px;">✓ Senkronizasyon: <span style="color: var(--matrix-green);">HAZIR</span>
                </p>
                <p style="margin-bottom: 10px;">✓ Bölgeler: <span style="color: var(--matrix-green);">Ankara, İstanbul,
                        İzmir, Bursa</span></p>
                <p>✓ Son Güncelleme: <span style="color: var(--matrix-green);" id="last-update">-</span></p>
            </div>
        </div>
    </div>

    <!-- EMPLOYEES TAB -->
    <div id="employees" class="tab-content">
        <div class="card">
            <h2>>>> ÇALIŞAN LİSTESİ</h2>

            <!-- Tarih Filtreleri (Çalışan Özeti İçin) -->
            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <label style="color: var(--text-secondary);">AY:</label>
                <select id="emp-month-filter" onchange="loadEmployeeData()"
                    style="background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 12px; font-family: 'Courier New', monospace;">
                    <option value="">[ TÜM AYLAR ]</option>
                    <option value="01">Ocak</option>
                    <option value="02">Şubat</option>
                    <option value="03">Mart</option>
                    <option value="04">Nisan</option>
                    <option value="05">Mayıs</option>
                    <option value="06">Haziran</option>
                    <option value="07">Temmuz</option>
                    <option value="08">Ağustos</option>
                    <option value="09">Eylül</option>
                    <option value="10">Ekim</option>
                    <option value="11">Kasım</option>
                    <option value="12">Aralık</option>
                </select>

                <label style="color: var(--text-secondary);">YIL:</label>
                <select id="emp-year-filter" onchange="loadEmployeeData()"
                    style="background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 12px; font-family: 'Courier New', monospace;">
                    <option value="">[ TÜM YILLAR ]</option>
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                </select>
            </div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>ID</th>
                            <th>AD SOYAD</th>
                            <th>DEPARTMAN</th>
                            <th>ÜNVAN</th>
                            <th>BÖLGE</th>
                            <th>FAZLA MESAİ</th>
                        </tr>
                    </thead>
                    <tbody id="employees-table">
                        <tr>
                            <td colspan="7" class="loading">Yükleniyor</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TIMESHEETS TAB -->
    <div id="timesheets" class="tab-content">
        <div class="card">
            <h2>>>> PUANTAJ KAYITLARI</h2>

            <!-- Tarih Filtreleri -->
            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <label style="color: var(--text-secondary);">AY:</label>
                <select id="ts-month-filter" onchange="filterTimesheets()"
                    style="background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 12px; font-family: 'Courier New', monospace;">
                    <option value="">[ TÜM AYLAR ]</option>
                    <option value="01">Ocak</option>
                    <option value="02">Şubat</option>
                    <option value="03">Mart</option>
                    <option value="04">Nisan</option>
                    <option value="05">Mayıs</option>
                    <option value="06">Haziran</option>
                    <option value="07">Temmuz</option>
                    <option value="08">Ağustos</option>
                    <option value="09">Eylül</option>
                    <option value="10">Ekim</option>
                    <option value="11">Kasım</option>
                    <option value="12">Aralık</option>
                </select>

                <label style="color: var(--text-secondary);">YIL:</label>
                <select id="ts-year-filter" onchange="filterTimesheets()"
                    style="background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 12px; font-family: 'Courier New', monospace;">
                    <option value="">[ TÜM YILLAR ]</option>
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                </select>

                <span id="ts-count"
                    style="padding: 8px 12px; color: var(--matrix-green); font-family: 'Courier New', monospace; border: 1px solid var(--border-color); background: var(--card-bg);">
                    >> KAYIT: -
                </span>
            </div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>ÇALIŞAN</th>
                            <th>TARİH</th>
                            <th>GİRİŞ</th>
                            <th>ÇIKIŞ</th>
                            <th>MOLA (dk)</th>
                            <th>BÖLGE</th>
                        </tr>
                    </thead>
                    <tbody id="timesheets-table">
                        <tr>
                            <td colspan="6" class="loading">Yükleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- STOCK TAB -->
    <div id="stock" class="tab-content">
        <div class="card">
            <h2>>>> STOK ENVANTERİ</h2>

            <!-- Premium Stock Control Panel -->
            <div class="stock-control-panel">
                <div class="control-group">
                    <button id="scan-btn" onclick="startScanner()" class="stock-ctrl-btn stock-ctrl-primary"
                        title="Barkod Tara">
                        <span class="stock-ctrl-icon">⊞</span>
                        <span class="stock-ctrl-label">TARA</span>
                    </button>
                    <button id="pdf-btn" onclick="downloadPDF()" class="stock-ctrl-btn stock-ctrl-secondary"
                        title="PDF İndir">
                        <span class="stock-ctrl-icon">⎙</span>
                        <span class="stock-ctrl-label">PDF</span>
                    </button>
                    <button id="clear-scan-btn" onclick="clearScannedItems()" class="stock-ctrl-btn stock-ctrl-danger"
                        title="Taramaları Sıfırla">
                        <span class="stock-ctrl-icon">⟲</span>
                        <span class="stock-ctrl-label">SIFIRLA</span>
                    </button>
                </div>
                <div class="scan-status">
                    <span class="status-label">TARANAN:</span>
                    <span class="status-value" id="scan-count">0</span>
                </div>
            </div>

            <!-- Barkod Tarayıcı Modal - MATRIX TEMASI -->
            <div id="scanner-modal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
                <div
                    style="background: var(--card-bg); padding: 20px; border: 2px solid var(--matrix-green); border-radius: 5px; max-width: 500px; width: 95%; text-align: center; box-shadow: 0 0 30px rgba(0, 255, 65, 0.3); max-height: 90vh; display: flex; flex-direction: column;">
                    <h3
                        style="color: var(--matrix-green); margin-bottom: 10px; font-family: 'Courier New', monospace; text-shadow: 0 0 10px var(--matrix-green); font-size: 16px; display: flex; justify-content: space-between; align-items: center;">
                        <span>&gt;&gt; SCANNER PRO &lt;&lt;</span>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button onclick="toggleTorch()" id="torch-btn" class="matrix-btn-small"
                                style="display: none; font-family: 'Courier New', monospace; font-size: 9px; padding: 3px 8px;">FLASH</button>
                            <span id="zoom-controls" style="display: none; align-items: center; gap: 5px;">
                                <span
                                    style="font-size: 9px; font-family: 'Courier New', monospace; color: var(--text-muted);">-</span>
                                <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1"
                                    oninput="updateZoom(this.value)"
                                    style="width: 60px; height: 3px; background: #333; border: 1px solid var(--matrix-green); border-radius: 0; outline: none; -webkit-appearance: none; appearance: none;">
                                <span
                                    style="font-size: 9px; font-family: 'Courier New', monospace; color: var(--text-muted);">+</span>
                                <span
                                    style="font-size: 8px; color: var(--matrix-green); font-family: 'Courier New', monospace; min-width: 30px; text-align: center;"
                                    id="zoom-level">1.0x</span>
                            </span>
                        </div>
                    </h3>

                    <!-- Kamera Alanı -->
                    <!-- Kamera Alanı (Viewfinder) -->
                    <div
                        style="position: relative; width: 100%; height: 280px; margin-bottom: 10px; border: 1px solid var(--border-color); background: #000; overflow: hidden;">
                        <div id="scanner-container" style="width: 100%; height: 100%;"></div>

                        <!-- Nişangah / Viewfinder Overlay -->
                        <div class="scanner-overlay" style="pointer-events: none;">
                            <div class="scanner-box"></div>
                            <div class="scanner-line"></div>
                        </div>
                    </div>

                    <p id="scan-result"
                        style="color: var(--matrix-green); margin-bottom: 10px; font-size: 14px; font-family: 'Courier New', monospace; min-height: 20px;">
                        Barkodu kameraya gösterin_
                    </p>

                    <!-- Tarananlar Listesi -->
                    <div style="text-align: left; margin-bottom: 5px; color: var(--text-muted); font-size: 11px;">SON
                        TARANANLAR:</div>
                    <div id="scanner-list"
                        style="flex: 1; overflow-y: auto; background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; margin-bottom: 15px; min-height: 100px;">
                        <!-- Tarananlar buraya eklenecek -->
                        <div style="text-align: center; color: #555; font-size: 11px; padding-top: 20px;">Henüz tarama
                            yapılmadı</div>
                    </div>

                    <button onclick="stopScanner()" class="matrix-btn matrix-btn-danger" style="width: 100%;">
                        [ KAPAT ]
                    </button>

                    <div style="font-size: 9px; color: #444; margin-top: 5px;">
                        Native API: <span id="native-api-status">Checking...</span> | Cam: <span id="cam-res">-</span>
                    </div>
                </div>
            </div>

            <style>
                /* === PREMIUM CONTROL PANEL BUTTONS === */
                .control-panel {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                }

                .ctrl-btn {
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 8px 14px;
                    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.6));
                    border: 1px solid var(--primary-color);
                    border-radius: 4px;
                    color: var(--primary-color);
                    font-family: 'Share Tech Mono', monospace;
                    font-size: 11px;
                    font-weight: 600;
                    letter-spacing: 1px;
                    text-decoration: none;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                    position: relative;
                    overflow: hidden;
                }

                .ctrl-btn::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
                    transition: left 0.5s;
                }

                .ctrl-btn:hover::before {
                    left: 100%;
                }

                .ctrl-btn:hover {
                    background: var(--primary-color);
                    color: var(--text-inverse);
                    box-shadow: 0 0 20px var(--primary-glow), inset 0 0 10px rgba(255, 255, 255, 0.2);
                    transform: translateY(-2px);
                }

                .ctrl-icon {
                    font-size: 16px;
                    line-height: 1;
                }

                .ctrl-label {
                    font-size: 10px;
                }

                /* === STOCK CONTROL PANEL === */
                .stock-control-panel {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    gap: 15px;
                    margin-bottom: 20px;
                    padding: 15px;
                    background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.5));
                    border: 1px solid var(--border-color);
                    border-radius: 6px;
                    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
                }

                .control-group {
                    display: flex;
                    gap: 8px;
                    flex-wrap: wrap;
                }

                .stock-ctrl-btn {
                    display: inline-flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                    min-width: 70px;
                    padding: 10px 12px;
                    background: linear-gradient(135deg, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.7));
                    border: 1px solid;
                    border-radius: 4px;
                    font-family: 'Share Tech Mono', monospace;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;
                }

                .stock-ctrl-btn::after {
                    content: '';
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    height: 2px;
                    background: currentColor;
                    transform: scaleX(0);
                    transition: transform 0.3s;
                }

                .stock-ctrl-btn:hover::after {
                    transform: scaleX(1);
                }

                .stock-ctrl-primary {
                    border-color: var(--primary-color);
                    color: var(--primary-color);
                }

                .stock-ctrl-primary:hover {
                    background: var(--primary-color);
                    color: var(--text-inverse);
                    box-shadow: 0 0 20px var(--primary-glow);
                    transform: translateY(-2px);
                }

                .stock-ctrl-secondary {
                    border-color: var(--text-secondary);
                    color: var(--text-secondary);
                }

                .stock-ctrl-secondary:hover {
                    background: var(--text-secondary);
                    color: var(--text-inverse);
                    box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
                    transform: translateY(-2px);
                }

                .stock-ctrl-danger {
                    border-color: #ff6b6b;
                    color: #ff6b6b;
                }

                .stock-ctrl-danger:hover {
                    background: #ff6b6b;
                    color: white;
                    box-shadow: 0 0 15px rgba(255, 107, 107, 0.5);
                    transform: translateY(-2px);
                }

                .stock-ctrl-icon {
                    font-size: 20px;
                    line-height: 1;
                }

                .stock-ctrl-label {
                    font-size: 9px;
                    font-weight: 700;
                    letter-spacing: 1px;
                }

                .scan-status {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px 16px;
                    background: rgba(0, 0, 0, 0.4);
                    border: 1px solid var(--border-color);
                    border-radius: 4px;
                    font-family: 'Share Tech Mono', monospace;
                }

                .status-label {
                    font-size: 10px;
                    color: var(--text-muted);
                    letter-spacing: 1px;
                }

                .status-value {
                    font-size: 18px;
                    font-weight: bold;
                    color: var(--primary-color);
                    text-shadow: 0 0 10px var(--primary-glow);
                    min-width: 30px;
                    text-align: center;
                }

                /* Mobile Responsiveness */
                @media (max-width: 768px) {
                    .control-panel {
                        gap: 5px;
                    }

                    .ctrl-btn {
                        padding: 6px 10px;
                        gap: 4px;
                    }

                    .ctrl-icon {
                        font-size: 14px;
                    }

                    .ctrl-label {
                        font-size: 9px;
                    }

                    .stock-control-panel {
                        flex-direction: column;
                        gap: 12px;
                        padding: 12px;
                    }

                    .control-group {
                        width: 100%;
                        justify-content: center;
                    }

                    .stock-ctrl-btn {
                        flex: 1;
                        min-width: 60px;
                    }

                    .scan-status {
                        width: 100%;
                        justify-content: center;
                    }
                }

                /* MODERN ERP STYLES */
                .matrix-btn {
                    padding: 8px 16px;
                    font-family: 'Exo 2', sans-serif;
                    font-weight: 600;
                    font-size: 12px;
                    letter-spacing: 1px;
                    border: 1px solid var(--matrix-green);
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    text-transform: uppercase;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    background: rgba(0, 0, 0, 0.2);
                    backdrop-filter: blur(4px);
                }

                .matrix-btn-primary {
                    background: rgba(0, 255, 65, 0.1);
                    color: var(--matrix-green);
                    box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
                }

                .matrix-btn-primary:hover {
                    background: var(--matrix-green);
                    color: black;
                    box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
                }

                .matrix-btn-secondary {
                    background: rgba(255, 255, 255, 0.05);
                    color: var(--text-secondary);
                    border-color: var(--text-muted);
                }

                .matrix-btn-secondary:hover {
                    background: var(--text-secondary);
                    color: black;
                    box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
                }

                .matrix-btn-warning {
                    background: rgba(255, 152, 0, 0.1);
                    color: #ff9800;
                    border-color: #ff9800;
                }

                .matrix-btn-warning:hover {
                    background: #ff9800;
                    color: black;
                    box-shadow: 0 0 15px rgba(255, 152, 0, 0.4);
                }

                .matrix-btn-danger {
                    background: rgba(255, 68, 68, 0.1);
                    color: #ff4444;
                    border-color: #ff4444;
                }

                .matrix-btn-danger:hover {
                    background: #ff4444;
                    color: white;
                    box-shadow: 0 0 15px rgba(255, 68, 68, 0.4);
                }

                .scanned-item {
                    background: rgba(0, 255, 65, 0.3) !important;
                    border-left: 3px solid var(--matrix-green) !important;
                }

                .scanned-item td {
                    color: var(--matrix-green) !important;
                    font-weight: bold;
                }

                /* Mobile Optimizations */
                @media (max-width: 768px) {
                    .matrix-btn {
                        padding: 10px 14px;
                        /* Larger touch target */
                        font-size: 11px;
                        flex: 1;
                    }

                    #scan-count {
                        padding: 10px !important;
                        font-size: 11px !important;
                        white-space: nowrap;
                    }

                    /* Table Fixes */
                    .table-responsive {
                        border: 1px solid var(--border-color);
                        border-radius: 4px;
                    }

                    /* Make text break formatted for mobile */
                    table td,
                    table th {
                        font-family: 'Share Tech Mono', monospace;
                        font-size: 12px;
                    }

                    /* Ensure child row needs no special hiding that breaks layout */
                    .child-row.show {
                        display: table-row !important;
                        animation: slideDown 0.3s ease;
                    }

                    @keyframes slideDown {
                        from {
                            opacity: 0;
                            transform: translateY(-10px);
                        }

                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }

                    /* Indent child rows instead of hiding first col if needed */
                    .child-row td {
                        background: rgba(255, 255, 255, 0.02);
                        padding: 10px 5px !important;
                        border-bottom: 1px dashed var(--border-color) !important;
                        white-space: normal !important;
                    }

                    /* Hide empty first cell in child row on mobile to save space */
                    .child-row td:first-child {
                        display: none;
                    }

                    #scanner-modal {
                        justify-content: flex-start !important;
                        padding-top: 20px;
                        overflow-y: auto;
                    }
                }

                .scanner-entry {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 8px;
                    border-bottom: 1px solid #333;
                    font-family: 'Share Tech Mono', monospace;
                    font-size: 12px;
                    animation: slideIn 0.3s ease;
                }

                .scanner-entry:last-child {
                    border-bottom: none;
                }

                .scanner-entry .code {
                    color: var(--matrix-green);
                    font-weight: bold;
                }

                .scanner-entry .name {
                    color: #aaa;
                    margin-left: 10px;
                    flex: 1;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }

                .scanner-entry .time {
                    color: #555;
                    font-size: 10px;
                }

                @keyframes slideIn {
                    from {
                        transform: translateX(-10px);
                        opacity: 0;
                    }

                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }

                /* PRO SCANNER STYLES */
                .scanner-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                }

                .scanner-box {
                    width: 70%;
                    height: 120px;
                    border: 2px solid rgba(0, 255, 65, 0.5);
                    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
                    /* Dim outside */
                    border-radius: 10px;
                    position: relative;
                }

                .scanner-box::before,
                .scanner-box::after {
                    content: '';
                    position: absolute;
                    width: 20px;
                    height: 20px;
                    border-color: var(--matrix-green);
                    border-style: solid;
                }

                .scanner-box::before {
                    top: -2px;
                    left: -2px;
                    border-width: 3px 0 0 3px;
                }

                .scanner-box::after {
                    bottom: -2px;
                    right: -2px;
                    border-width: 0 3px 3px 0;
                }

                .scanner-line {
                    position: absolute;
                    width: 90%;
                    height: 2px;
                    background: #ff4444;
                    top: 50%;
                    left: 5%;
                    box-shadow: 0 0 4px #ff0000;
                    animation: scanMove 2s infinite ease-in-out;
                }

                @keyframes scanMove {

                    0%,
                    100% {
                        top: 40%;
                        opacity: 0.5;
                    }

                    50% {
                        top: 60%;
                        opacity: 1;
                    }
                }

                .matrix-btn-small {
                    background: rgba(0, 0, 0, 0.5);
                    color: var(--matrix-green);
                    border: 1px solid var(--matrix-green);
                    border-radius: 4px;
                    padding: 2px 8px;
                    font-size: 12px;
                    cursor: pointer;
                }

                .matrix-btn-small:hover {
                    background: var(--matrix-green);
                    color: black;
                }

                /* Matrix Slider Styling */
                #zoom-slider::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    appearance: none;
                    width: 12px;
                    height: 12px;
                    background: var(--matrix-green);
                    border: 1px solid var(--matrix-green);
                    cursor: pointer;
                    box-shadow: 0 0 5px var(--matrix-green);
                }

                #zoom-slider::-moz-range-thumb {
                    width: 12px;
                    height: 12px;
                    background: var(--matrix-green);
                    border: 1px solid var(--matrix-green);
                    cursor: pointer;
                    box-shadow: 0 0 5px var(--matrix-green);
                    border-radius: 0;
                }

                #zoom-slider::-webkit-slider-track {
                    background: #333;
                    border: 1px solid var(--matrix-green);
                    height: 3px;
                }

                #zoom-slider::-moz-range-track {
                    background: #333;
                    border: 1px solid var(--matrix-green);
                    height: 3px;
                }

                /* PRO SCANNER STYLES */
                .scanner-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                }

                .scanner-box {
                    width: 70%;
                    height: 120px;
                    border: 2px solid rgba(0, 255, 65, 0.5);
                    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
                    /* Dim outside */
                    border-radius: 10px;
                    position: relative;
                }

                .scanner-box::before,
                .scanner-box::after {
                    content: '';
                    position: absolute;
                    width: 20px;
                    height: 20px;
                    border-color: var(--matrix-green);
                    border-style: solid;
                }

                .scanner-box::before {
                    top: -2px;
                    left: -2px;
                    border-width: 3px 0 0 3px;
                }

                .scanner-box::after {
                    bottom: -2px;
                    right: -2px;
                    border-width: 0 3px 3px 0;
                }

                .scanner-line {
                    position: absolute;
                    width: 90%;
                    height: 2px;
                    background: #ff4444;
                    top: 50%;
                    left: 5%;
                    box-shadow: 0 0 4px #ff0000;
                    animation: scanMove 2s infinite ease-in-out;
                }

                @keyframes scanMove {

                    0%,
                    100% {
                        top: 40%;
                        opacity: 0.5;
                    }

                    50% {
                        top: 60%;
                        opacity: 1;
                    }
                }

                .matrix-btn-small {
                    background: rgba(0, 0, 0, 0.5);
                    color: var(--matrix-green);
                    border: 1px solid var(--matrix-green);
                    border-radius: 4px;
                    padding: 2px 8px;
                    font-size: 12px;
                    cursor: pointer;
                }

                .matrix-btn-small:hover {
                    background: var(--matrix-green);
                    color: black;
                }

                /* PRO SCANNER STYLES */
                .scanner-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                }

                .scanner-box {
                    width: 70%;
                    height: 120px;
                    border: 2px solid rgba(0, 255, 65, 0.5);
                    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
                    /* Dim outside */
                    border-radius: 10px;
                    position: relative;
                }

                .scanner-box::before,
                .scanner-box::after {
                    content: '';
                    position: absolute;
                    width: 20px;
                    height: 20px;
                    border-color: var(--matrix-green);
                    border-style: solid;
                }

                .scanner-box::before {
                    top: -2px;
                    left: -2px;
                    border-width: 3px 0 0 3px;
                }

                .scanner-box::after {
                    bottom: -2px;
                    right: -2px;
                    border-width: 0 3px 3px 0;
                }

                .scanner-line {
                    position: absolute;
                    width: 90%;
                    height: 2px;
                    background: #ff4444;
                    top: 50%;
                    left: 5%;
                    box-shadow: 0 0 4px #ff0000;
                    animation: scanMove 2s infinite ease-in-out;
                }

                @keyframes scanMove {

                    0%,
                    100% {
                        top: 40%;
                        opacity: 0.5;
                    }

                    50% {
                        top: 60%;
                        opacity: 1;
                    }
                }

                .matrix-btn-small {
                    background: rgba(0, 0, 0, 0.5);
                    color: var(--matrix-green);
                    border: 1px solid var(--matrix-green);
                    border-radius: 4px;
                    padding: 2px 8px;
                    font-size: 12px;
                    cursor: pointer;
                }

                .matrix-btn-small:hover {
                    background: var(--matrix-green);
                    color: black;
                }

                /* === ARAÇLAR MODÜLÜ STYLES === */
                .vehicles-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                    gap: 20px;
                    padding: 10px;
                }

                .vehicle-card {
                    background: var(--card-bg);
                    border: 2px solid var(--matrix-green);
                    border-radius: 8px;
                    padding: 20px;
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;
                }

                .vehicle-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 15px 40px rgba(0, 255, 65, 0.4) !important;
                }

                .vehicle-card::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(0, 255, 65, 0.1), transparent);
                    transition: left 0.5s;
                }

                .vehicle-card:hover::before {
                    left: 100%;
                }

                .vehicle-header {
                    text-align: center;
                    margin-bottom: 15px;
                    padding-bottom: 15px;
                    border-bottom: 1px solid var(--border-color);
                }

                .matrix-bracket {
                    color: var(--matrix-green);
                    font-size: 24px;
                    font-weight: bold;
                    font-family: 'Courier New', monospace;
                }

                .vehicle-plate {
                    font-size: 28px;
                    font-weight: bold;
                    color: var(--matrix-green);
                    font-family: 'Courier New', monospace;
                    letter-spacing: 3px;
                    text-shadow: 0 0 10px var(--matrix-green);
                    margin: 0 5px;
                }

                .vehicle-info {
                    margin-bottom: 15px;
                }

                .info-line {
                    display: flex;
                    justify-content: space-between;
                    padding: 8px 0;
                    border-bottom: 1px dashed var(--border-color);
                    font-family: 'Courier New', monospace;
                    font-size: 13px;
                }

                .info-line .label {
                    color: var(--text-secondary);
                    font-weight: bold;
                }

                .info-line .value {
                    color: var(--matrix-green);
                    text-align: right;
                }

                .alert-section {
                    margin: 15px 0;
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 4px;
                }

                .alert-item {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px;
                    margin-bottom: 5px;
                    border-left: 3px solid;
                    background: rgba(0, 0, 0, 0.2);
                    font-family: 'Courier New', monospace;
                    font-size: 12px;
                    font-weight: bold;
                    animation: matrix-pulse 2s infinite;
                }

                .alert-item:last-child {
                    margin-bottom: 0;
                }

                .alert-icon {
                    font-size: 16px;
                }

                .alert-text {
                    flex: 1;
                    letter-spacing: 1px;
                }

                @keyframes matrix-pulse {

                    0%,
                    100% {
                        opacity: 1;
                    }

                    50% {
                        opacity: 0.7;
                    }
                }

                .progress-section {
                    margin-top: 15px;
                    padding-top: 15px;
                    border-top: 1px solid var(--border-color);
                }

                .progress-label {
                    font-family: 'Courier New', monospace;
                    font-size: 11px;
                    color: var(--text-secondary);
                    margin-bottom: 8px;
                    letter-spacing: 1px;
                }

                .matrix-progress {
                    height: 20px;
                    background: rgba(0, 0, 0, 0.5);
                    border: 1px solid var(--border-color);
                    border-radius: 4px;
                    overflow: hidden;
                    position: relative;
                }

                .progress-fill {
                    height: 100%;
                    transition: width 0.5s ease;
                    position: relative;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .progress-glow {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                    animation: progress-shine 2s infinite;
                }

                @keyframes progress-shine {
                    0% {
                        transform: translateX(-100%);
                    }

                    100% {
                        transform: translateX(100%);
                    }
                }

                .progress-text {
                    font-family: 'Courier New', monospace;
                    font-size: 11px;
                    color: var(--text-muted);
                    text-align: center;
                    margin-top: 5px;
                }

                @media (max-width: 768px) {
                    .vehicles-grid {
                        grid-template-columns: 1fr;
                        gap: 15px;
                    }

                    .vehicle-plate {
                        font-size: 22px;
                    }

                    .info-line {
                        font-size: 12px;
                    }
                }
            </style>

            <!-- Arama ve Filtre -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="stock-search" placeholder="Ara..."
                    style="flex: 1; min-width: 150px; padding: 10px; background: var(--card-bg); border: 1px solid var(--border-color); color: var(--matrix-green); border-radius: 5px;">
                <select id="stock-region-filter"
                    style="padding: 10px; background: var(--card-bg); border: 1px solid var(--border-color); color: var(--matrix-green); border-radius: 5px;">
                    <option value="">Tüm Bölgeler</option>
                    <option value="Ankara">Ankara</option>
                    <option value="Istanbul">İstanbul</option>
                    <option value="Izmir">İzmir</option>
                    <option value="Bursa">Bursa</option>
                </select>
            </div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>STOK KODU</th>
                            <th>SERİ SAYISI</th>
                            <th>ÜRÜN ADI</th>
                            <th>BÖLGE</th>
                        </tr>
                    </thead>
                    <tbody id="stock-table">
                        <tr>
                            <td colspan="5" class="loading">Yükleniyor</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- VEHICLES TAB -->
    <div id="vehicles" class="tab-content">
        <!-- İstatistik Kartları -->
        <div class="stats-grid" style="margin-bottom: 20px;">
            <div class="stat-card">
                <h3>Toplam Araç</h3>
                <div class="value" id="total-vehicles">-</div>
            </div>
            <div class="stat-card" style="border-color: #ff4444;">
                <h3>Kritik Uyarı</h3>
                <div class="value" id="critical-vehicles" style="color: #ff4444;">-</div>
            </div>
            <div class="stat-card" style="border-color: #FFD700;">
                <h3>Yaklaşan İşlem</h3>
                <div class="value" id="warning-vehicles" style="color: #FFD700;">-</div>
            </div>
            <div class="stat-card" style="border-color: var(--matrix-green);">
                <h3>Normal Durum</h3>
                <div class="value" id="normal-vehicles" style="color: var(--matrix-green);">-</div>
            </div>
        </div>

        <!-- Araç Kartları -->
        <div id="vehicles-grid" class="vehicles-grid">
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                <div class="loading">Araçlar yükleniyor...</div>
            </div>
        </div>
    </div>

    <!-- REPORTS TAB -->
    <div id="reports" class="tab-content">
        <div class="card">
            <h2>>>> RAPORLAR</h2>
            <p style="padding: 20px; color: var(--text-muted);">Rapor modülü yakında eklenecek...</p>
        </div>
    </div>
</div>

<script>
    // Update last update time
    document.getElementById('last-update').textContent = new Date().toLocaleString('tr-TR');

    // Tab switching
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.classList.remove('active');
        });

        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');

        if (tabName === 'stock') {
            loadStockData();
        } else if (tabName === 'employees') {
            loadEmployeeData();
        } else if (tabName === 'timesheets') {
            loadTimesheetsData();
        } else if (tabName === 'vehicles') {
            loadVehiclesData();
        }
    }

    // ==== TIMESHEETS DATA ====
    let timesheetsData = [];

    function loadTimesheetsData() {
        const tbody = document.getElementById('timesheets-table');
        tbody.innerHTML = '<tr><td colspan="6" class="loading">Yükleniyor...</td></tr>';

        fetch('/api/timesheets')
            .then(res => res.json())
            .then(data => {
                timesheetsData = data;
                filterTimesheets();
            })
            .catch(err => {
                console.error('Timesheets error:', err);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #ff4444;">Veri yüklenemedi</td></tr>';
            });
    }

    function filterTimesheets() {
        const month = document.getElementById('ts-month-filter').value;
        const year = document.getElementById('ts-year-filter').value;

        let filtered = timesheetsData;

        if (month) {
            filtered = filtered.filter(ts => {
                const date = ts.work_date || ts[3] || '';
                return date.substring(5, 7) === month;
            });
        }

        if (year) {
            filtered = filtered.filter(ts => {
                const date = ts.work_date || ts[3] || '';
                return date.substring(0, 4) === year;
            });
        }

        renderTimesheetsTable(filtered);
        document.getElementById('ts-count').textContent = `>> KAYIT: ${filtered.length}`;
    }

    function renderTimesheetsTable(data) {
        const tbody = document.getElementById('timesheets-table');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">Bu dönemde kayıt bulunamadı</td></tr>';
            return;
        }

        let html = '';
        data.forEach(ts => {
            // Array veya object olabilir
            const employee = ts.employee_name || ts[2] || '-';
            const workDate = ts.work_date || ts[3] || '-';
            const startTime = ts.start_time || ts[4] || '-';
            const endTime = ts.end_time || ts[5] || '-';
            const breakMins = ts.break_minutes || ts[6] || 0;
            const region = ts.region || ts[9] || '-';

            html += `<tr>
                <td>${employee}</td>
                <td>${workDate}</td>
                <td>${startTime}</td>
                <td>${endTime}</td>
                <td>${breakMins}</td>
                <td>${region}</td>
            </tr>`;
        });

        tbody.innerHTML = html;
    }

    // Load employee data with overtime calculation
    let employeeData = [];

    function loadEmployeeData() {
        const tbody = document.getElementById('employees-table');
        tbody.innerHTML = '<tr><td colspan="7" class="loading">Yükleniyor</td></tr>';

        // Filtre değerlerini al
        const month = document.getElementById('emp-month-filter').value;
        const year = document.getElementById('emp-year-filter').value;

        let url = '/api/employee-overtime';
        if (month || year) {
            const params = new URLSearchParams();
            if (month) params.append('month', month);
            if (year) params.append('year', year);
            url += '?' + params.toString();
        }

        fetch(url)
            .then(res => res.json())
            .then(data => {
                employeeData = data;
                renderEmployeeTable(data);
            })
            .catch(err => {
                console.error('Employee data error:', err);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ff4444;">Veri yüklenemedi</td></tr>';
            });
    }

    function renderEmployeeTable(data) {
        const tbody = document.getElementById('employees-table');

        // Update global array so toggleEmployee uses correct filtered data
        employeeData = data;

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">Henüz çalışan verisi yok</td></tr>';
            return;
        }

        let html = '';
        data.forEach((emp, index) => {
            // Parent row - using data attribute instead of onclick for better mobile support
            html += `<tr class="parent-row employee-toggle" data-emp-index="${index}" style="cursor: pointer; touch-action: manipulation;">
                <td><span class="expand-icon" id="emp-icon-${index}">▶</span></td>
                <td>${emp.id}</td>
                <td>${emp.name}</td>
                <td>${emp.department || '-'}</td>
                <td>${emp.title || '-'}</td>
                <td>${emp.region || '-'}</td>
                <td style="color: ${emp.overtime > 0 ? 'var(--matrix-green)' : 'var(--text-muted)'};">
                    ${emp.overtime.toFixed(1)} saat
                </td>
            </tr>`;

            // Child row for timesheet details
            html += `<tr class="child-row" id="emp-child-${index}">
                <td colspan="7">
                    <div id="emp-details-${index}" style="padding: 15px;">
                        <div class="loading">Mesai kayıtları yükleniyor...</div>
                    </div>
                </td>
            </tr>`;
        });

        tbody.innerHTML = html;
        attachEmployeeListeners();
    }

    function attachEmployeeListeners() {
        const rows = document.querySelectorAll('.employee-toggle');
        rows.forEach(row => {
            row.replaceWith(row.cloneNode(true));
        });

        document.querySelectorAll('.employee-toggle').forEach(row => {
            let touchStartX = 0;
            let touchStartY = 0;
            let isTouchMove = false;

            row.addEventListener('touchstart', function (e) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isTouchMove = false;
            });

            row.addEventListener('touchmove', function (e) {
                const touchEndX = e.touches[0].clientX;
                const touchEndY = e.touches[0].clientY;
                const deltaX = Math.abs(touchEndX - touchStartX);
                const deltaY = Math.abs(touchEndY - touchStartY);

                // If scroll is more than 10px, mark as scroll
                if (deltaX > 10 || deltaY > 10) {
                    isTouchMove = true;
                }
            });

            row.addEventListener('touchend', function (e) {
                // Only toggle if it wasn't a scroll
                if (!isTouchMove) {
                    e.preventDefault();
                    const index = parseInt(this.dataset.empIndex);
                    toggleEmployee(index);
                }
            });

            row.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                const index = parseInt(this.dataset.empIndex);
                toggleEmployee(index);
            });
        });
        console.log(`✅ Attached listeners to ${rows.length} employee rows`);
    }

    function toggleEmployee(index) {
        const childRow = document.getElementById(`emp-child-${index}`);
        const icon = document.getElementById(`emp-icon-${index}`);
        const detailsDiv = document.getElementById(`emp-details-${index}`);

        if (childRow.classList.contains('show')) {
            childRow.classList.remove('show');
            icon.classList.remove('expanded');
        } else {
            childRow.classList.add('show');
            icon.classList.add('expanded');

            // MOBILE FIX: Force visibility on some browsers
            const td = childRow.querySelector('td');
            if (td) {
                td.style.display = 'table-cell';
            }

            // Load timesheet details if not already loaded
            if (detailsDiv.innerHTML.includes('loading')) {
                loadEmployeeTimesheets(index, employeeData[index].id);
            }
        }
    }

    function loadEmployeeTimesheets(index, empId) {
        const detailsDiv = document.getElementById(`emp-details-${index}`);

        // Get current filter values
        const month = document.getElementById('emp-month-filter').value;
        const year = document.getElementById('emp-year-filter').value;

        // Build URL with filters
        let url = `/api/employee-timesheets/${empId}`;
        const params = new URLSearchParams();
        if (month) params.append('month', month);
        if (year) params.append('year', year);
        if (params.toString()) url += '?' + params.toString();

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.length === 0) {
                    detailsDiv.innerHTML = '<p style="color: var(--text-muted);">Henüz mesai kaydı yok</p>';
                    return;
                }

                let html = '<div class="table-responsive"><table style="width: 100%; margin-top: 10px;"><thead><tr>';
                html += '<th>TARİH</th><th>GİRİŞ</th><th>ÇIKIŞ</th><th>MOLA (dk)</th><th>ÇALIŞILAN</th><th>FAZLA MESAİ</th><th>GECE</th></tr></thead><tbody>';

                data.forEach(ts => {
                    // Highlight row if there's overtime
                    const hasOvertime = ts.overtime > 0;
                    const rowStyle = hasOvertime ? 'background: var(--active-bg); border-left: 3px solid var(--primary-color);' : 'background: var(--hover-bg);';

                    html += `<tr style="${rowStyle}">
                        <td style="display: table-cell; min-width: 85px;">${ts.work_date}</td>
                        <td style="display: table-cell;">${ts.start_time}</td>
                        <td style="display: table-cell;">${ts.end_time}</td>
                        <td style="display: table-cell;">${ts.break_minutes}</td>
                        <td style="display: table-cell;">${ts.worked_hours.toFixed(1)} saat</td>
                        <td style="display: table-cell; color: ${ts.overtime > 0 ? 'var(--primary-color)' : 'var(--text-muted)'}; font-weight: ${ts.overtime > 0 ? 'bold' : 'normal'};">${ts.overtime.toFixed(1)} saat</td>
                        <td style="display: table-cell; color: ${ts.night_hours > 0 ? 'var(--primary-color)' : 'var(--text-muted)'}; font-weight: ${ts.night_hours > 0 ? 'bold' : 'normal'};">${ts.night_hours.toFixed(1)} saat</td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
                detailsDiv.innerHTML = html;
            })
            .catch(err => {
                console.error('Timesheet error:', err);
                detailsDiv.innerHTML = '<p style="color: #ff4444;">Mesai kayıtları yüklenemedi</p>';
            });
    }

    // Load stock data with collapsible rows
    let stockData = [];

    function loadStockData() {
        const tbody = document.getElementById('stock-table');
        tbody.innerHTML = '<tr><td colspan="5" class="loading">Yükleniyor</td></tr>';

        fetch('/api/stock-data')
            .then(res => res.json())
            .then(data => {
                stockData = data;
                renderStockTable(data);
                document.getElementById('total-stock').textContent = data.length;
            })
            .catch(err => {
                console.error('Stock data error:', err);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #ff4444;">Stok verileri yüklenemedi</td></tr>';
            });
    }

    function renderStockTable(data) {
        const tbody = document.getElementById('stock-table');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted); padding: 30px;">[ SİSTEMDE STOK KAYDI YOK ]</td></tr>';
            return;
        }

        let html = '';
        data.forEach((item, index) => {
            // Get unique regions
            const regions = [...new Set(item.seri_list.map(s => s.bolge))].join(', ');

            // Parent row - NEW COLUMN ORDER: Stok Kodu, Seri Sayısı, Ürün Adı, Bölge
            html += `<tr class="parent-row stock-toggle" data-stock-index="${index}" style="cursor: pointer; touch-action: manipulation;">
                <td style="text-align: center;"><span class="expand-icon" id="icon-${index}">▶</span></td>
                <td style="font-weight: bold; color: var(--text-primary);">${item.stok_kod}</td>
                <td><span style="background: var(--hover-bg); padding: 2px 8px; border-radius: 4px; border: 1px solid var(--primary-color); color: var(--primary-color);">${item.seri_count} adet</span></td>
                <td>${item.stok_adi}</td>
                <td style="font-size: 0.9em; opacity: 0.8;">${regions}</td>
            </tr>`;

            // Child rows - THEME COLORS
            item.seri_list.forEach(seri => {
                html += `<tr class="child-row stock-child-${index}" style="background: var(--hover-bg);">
                    <td></td>
                    <td style="color: var(--text-secondary); padding-left: 20px;">└─ ${seri.seri_no || '-'}</td>
                    <td style="color: var(--text-muted); font-size: 13px;">${seri.durum || 'OK'}</td>
                    <td style="font-size: 13px; font-family: 'Share Tech Mono'; color: var(--text-secondary);">${seri.bolge || '-'}</td>
                    <td></td>
                </tr>`;
            });
        });

        tbody.innerHTML = html;

        // Add event listeners for mobile touch support
        attachStockListeners();
    }

    function attachStockListeners() {
        const rows = document.querySelectorAll('.stock-toggle');
        rows.forEach(row => {
            row.replaceWith(row.cloneNode(true));
        });

        document.querySelectorAll('.stock-toggle').forEach(row => {
            let touchStartX = 0;
            let touchStartY = 0;
            let isTouchMove = false;

            row.addEventListener('touchstart', function (e) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isTouchMove = false;
            });

            row.addEventListener('touchmove', function (e) {
                const touchEndX = e.touches[0].clientX;
                const touchEndY = e.touches[0].clientY;
                const deltaX = Math.abs(touchEndX - touchStartX);
                const deltaY = Math.abs(touchEndY - touchStartY);

                // If horizontal scroll is more than 10px, mark as scroll
                if (deltaX > 10 || deltaY > 10) {
                    isTouchMove = true;
                }
            });

            row.addEventListener('touchend', function (e) {
                // Only toggle if it wasn't a scroll
                if (!isTouchMove) {
                    e.preventDefault();
                    const index = parseInt(this.dataset.stockIndex);
                    toggleStock(index);
                }
            });

            row.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                const index = parseInt(this.dataset.stockIndex);
                toggleStock(index);
            });
        });
    }

    function toggleStock(index) {
        // Select by CLASS, not ID, to handle multiple rows correctly
        const children = document.querySelectorAll(`.stock-child-${index}`);
        const icon = document.getElementById(`icon-${index}`);

        // Toggle 'show' class
        const isClosed = !icon.classList.contains('expanded');

        children.forEach(child => {
            if (isClosed) {
                child.classList.add('show');
            } else {
                child.classList.remove('show');
            }
        });

        icon.classList.toggle('expanded');
    }

    // Stock search
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('stock-search');
        const regionFilter = document.getElementById('stock-region-filter');

        if (searchInput) {
            searchInput.addEventListener('input', filterStock);
        }

        if (regionFilter) {
            regionFilter.addEventListener('change', filterStock);
        }
    });

    function filterStock() {
        const search = document.getElementById('stock-search').value.toLowerCase();
        const region = document.getElementById('stock-region-filter').value;

        let filtered = stockData.filter(item => {
            const matchSearch = !search ||
                item.stok_kod.toLowerCase().includes(search) ||
                item.stok_adi.toLowerCase().includes(search);

            const matchRegion = !region ||
                item.seri_list.some(s => s.bolge === region);

            return matchSearch && matchRegion;
        });

        renderStockTable(filtered);
    }

    // ==============================================
    // BARKOD TARAYICI ve PDF EXPORT
    // ==============================================

    let scannedItems = new Map(); // Map kullanarak tekrarları önle (Key: Unique ID/Serial)
    let html5QrCode = null;
    let isScanLocked = false;
    let cameraTrack = null;
    let zoomCapability = null;

    // ... (normalizeCode and findStockItem unchanged) ...
    // Normalize string for fuzzy matching (remove spaces, lowercase)
    function normalizeCode(str) {
        if (!str) return '';
        return str.toString().replace(/[\s\-\_]/g, '').toLowerCase();
    }

    // Akıllı Eşleştirme (Bidirectional Substring Match)
    function findStockItem(scanCode) {
        const normalizedScan = normalizeCode(scanCode);

        for (const item of stockData) {
            // Check Stock Code first
            const normStockKod = normalizeCode(item.stok_kod);

            // 1. Exact or Substring Match on Stock Code
            if (normStockKod === normalizedScan || normStockKod.includes(normalizedScan) || normalizedScan.includes(normStockKod)) {
                return {
                    type: 'stock_code',
                    item: item,
                    seri: null,
                    matchCode: item.stok_kod
                };
            }

            // 2. Check Serials
            for (const seri of item.seri_list) {
                const normSeri = normalizeCode(seri.seri_no);
                if (normSeri === normalizedScan || normSeri.includes(normalizedScan) || normalizedScan.includes(normSeri)) {
                    return {
                        type: 'serial',
                        item: item,
                        seri: seri,
                        matchCode: seri.seri_no
                    };
                }
            }
        }
        return null;
    }

    // Barkod Tarayıcı Başlat (PRO MODE)
    function startScanner() {
        const modal = document.getElementById('scanner-modal');
        modal.style.display = 'flex';

        // Reset list UI if empty
        const list = document.getElementById('scanner-list');
        if (scannedItems.size === 0 && list) {
            list.innerHTML = '<div style="text-align: center; color: #555; font-size: 11px; padding-top: 20px;">Henüz tarama yapılmadı</div>';
        }

        if (!window.Html5Qrcode) {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js';
            script.onload = () => initScanner();
            document.head.appendChild(script);
        } else {
            initScanner();
        }
    }

    function initScanner() {
        // Use Native BarcodeDetector if supported
        // Full Industrial Format Support
        const formats = [
            Html5QrcodeSupportedFormats.QR_CODE,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.CODE_93,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.ITF,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E,
            Html5QrcodeSupportedFormats.CODABAR,
            Html5QrcodeSupportedFormats.DATA_MATRIX
        ];

        html5QrCode = new Html5Qrcode("scanner-container", {
            experimentalFeatures: { useBarCodeDetectorIfSupported: true },
            formatsToSupport: formats,
            verbose: false
        });

        // PROGRESSIVE FALLBACK CONFIGURATION
        // Try 4K first, then fallback to lower resolutions
        const configs = [
            {
                name: '4K',
                fps: 25,
                qrbox: function (w, h) {
                    return { width: Math.floor(w * 0.85), height: Math.floor(h * 0.4) };
                },
                aspectRatio: 1.0,
                videoConstraints: {
                    facingMode: "environment",
                    focusMode: "continuous",
                    width: { min: 1024, ideal: 3840, max: 4096 },
                    height: { min: 768, ideal: 2160, max: 2160 }
                },
                disableFlip: false
            },
            {
                name: '1080p',
                fps: 20,
                qrbox: function (w, h) {
                    return { width: Math.floor(w * 0.8), height: Math.floor(h * 0.35) };
                },
                aspectRatio: 1.0,
                videoConstraints: {
                    facingMode: "environment",
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                },
                disableFlip: false
            },
            {
                name: '720p',
                fps: 15,
                qrbox: function (w, h) {
                    return { width: Math.floor(w * 0.75), height: Math.floor(h * 0.3) };
                },
                aspectRatio: 1.0,
                videoConstraints: {
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                disableFlip: false
            }
        ];

        // Try configurations in order
        let configIndex = 0;

        function tryStart() {
            const config = configs[configIndex];

            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                setupCameraControls();

                // Visual Config Feedback
                const nativeStatus = document.getElementById('native-api-status');
                if (nativeStatus) {
                    nativeStatus.innerHTML = `<span style="color:#00FF41">${config.name} Mode</span>`;
                }

                document.getElementById('scan-result').innerHTML = 'Kamera hazır - Barkodu gösterin_';
            }).catch((err) => {
                console.error(`Failed to start with ${config.name}:`, err);
                configIndex++;

                if (configIndex < configs.length) {
                    // Try next config
                    console.log(`Trying ${configs[configIndex].name}...`);
                    tryStart();
                } else {
                    // All configs failed
                    const resultEl = document.getElementById('scan-result');
                    resultEl.innerHTML = `<span style="color:#ff4444;">Kamera Hatası</span>`;

                    // Show user-friendly error
                    let errorMsg = 'Kamera başlatılamadı. ';
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        errorMsg += 'Lütfen kamera iznini verin.';
                    } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                        errorMsg += 'Kamera bulunamadı.';
                    } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                        errorMsg += 'Kamera başka bir uygulama tarafından kullanılıyor.';
                    } else {
                        errorMsg += err.message || 'Bilinmeyen hata.';
                    }

                    alert(errorMsg);
                    stopScanner();
                }
            });
        }

        tryStart();
    }

    function onScanSuccess(decodedText, decodedResult) {
        // 1. Logic Lock (Prevent multiple triggers)
        if (isScanLocked) return;
        isScanLocked = true;

        // 2. Visual & Haptic Feedback (No Camera Pause)
        playBeep(1000, 250); // Success beep - higher pitch, longer
        if (navigator.vibrate) navigator.vibrate(200);

        const resultEl = document.getElementById('scan-result');
        const formatName = decodedResult ? decodedResult.result.format.formatName : 'RAW';

        console.log(`SCANNED: ${decodedText} [${formatName}]`);

        // 3. Process Result
        const match = findStockItem(decodedText);
        let resultHTML = '';

        if (match) {
            const res = processScannedItem(match);
            if (res.status === 'success') {
                resultHTML = `<div style="background: #000; color: var(--matrix-green); padding: 20px; border: 2px solid var(--matrix-green); border-radius: 0; box-shadow: 0 0 30px rgba(0,255,65,0.8); font-family: 'Courier New', monospace;">
                    <div style="font-size: 28px; font-weight: bold; text-shadow: 0 0 10px var(--matrix-green);">>> BAŞARILI <<</div>
                    <div style="font-size: 16px; margin-top: 10px; letter-spacing: 1px;">${res.msg}</div>
                    <div style="font-size: 11px; opacity: 0.7; margin-top: 8px; color: #0f0;">[${formatName}]</div>
                </div>`;
            } else if (res.status === 'duplicate') {
                resultHTML = `<div style="background: #000; color: #FFD700; padding: 20px; border: 2px solid #FFD700; border-radius: 0; box-shadow: 0 0 30px rgba(255,215,0,0.6); font-family: 'Courier New', monospace;">
                    <div style="font-size: 28px; font-weight: bold; text-shadow: 0 0 10px #FFD700;">>> UYARI <<</div>
                    <div style="font-size: 16px; margin-top: 10px; letter-spacing: 1px;">${res.msg}</div>
                    <div style="font-size: 11px; opacity: 0.7; margin-top: 8px;">[TEKRAR]</div>
                </div>`;
                playBeep(600, 150); // Warning - lower pitch
            }
        } else {
            resultHTML = `<div style="background: #000; color: #ff4444; padding: 20px; border: 2px solid #ff4444; border-radius: 0; box-shadow: 0 0 30px rgba(255,68,68,0.6); font-family: 'Courier New', monospace;">
                <div style="font-size: 28px; font-weight: bold; text-shadow: 0 0 10px #ff4444;">>> HATA <<</div>
                <div style="font-size: 16px; margin-top: 10px; letter-spacing: 1px; word-break: break-all;">${decodedText}</div>
                <div style="font-size: 11px; opacity: 0.7; margin-top: 8px; color: #f44;">[${formatName}]</div>
                <div style="margin-top: 12px; font-size: 12px; background: rgba(255,0,0,0.1); padding: 8px; border: 1px solid #f44;">STOK LİSTESİNDE YOK</div>
            </div>`;
            playBeep(300, 250); // Error - even lower pitch, longer
        }

        // 4. Show Freeze Overlay (UI Trick instead of stopping camera)
        // We inject a div OVER the video to hide the moving feed and show result
        const container = document.getElementById('scanner-container');
        let freezeOverlay = document.getElementById('scan-freeze-overlay');

        if (!freezeOverlay) {
            freezeOverlay = document.createElement('div');
            freezeOverlay.id = 'scan-freeze-overlay';
            freezeOverlay.style.cssText = "position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 10; backdrop-filter: blur(5px); transition: opacity 0.2s;";
            container.appendChild(freezeOverlay);
            // Ensure container is relative
            container.style.position = 'relative';
        }

        freezeOverlay.innerHTML = resultHTML;
        freezeOverlay.style.display = 'flex';
        freezeOverlay.style.opacity = '1';

        // Update text result too for history context
        resultEl.innerHTML = "...";

        // 5. Auto Resume Logic (Robust Timeout)
        setTimeout(() => {
            // Fade out overlay
            freezeOverlay.style.opacity = '0';
            setTimeout(() => {
                freezeOverlay.style.display = 'none';
                isScanLocked = false;
                resultEl.innerHTML = 'Hazır...';
            }, 200); // Wait for fade out
        }, 1500); // Display result for 1.5s
    }

    function onScanFailure(error) {
        // Ignore errors
    }

    function setupCameraControls() {
        const videoElement = document.querySelector("#scanner-container video");
        if (!videoElement) return;

        // Get Track
        try {
            const stream = videoElement.srcObject;
            const track = stream.getVideoTracks()[0];
            cameraTrack = track;

            const caps = track.getCapabilities();
            const settings = track.getSettings();

            // Resolution Info
            const camRes = document.getElementById('cam-res');
            if (camRes) camRes.textContent = `${settings.width}x${settings.height}`;

            // Torch Control
            const torchBtn = document.getElementById('torch-btn');
            if (torchBtn && caps.torch) {
                torchBtn.style.display = 'inline-block';
            }

            // Zoom Control
            const zoomControls = document.getElementById('zoom-controls');
            const zoomSlider = document.getElementById('zoom-slider');
            if (zoomControls && zoomSlider && caps.zoom) {
                zoomControls.style.display = 'inline-flex';
                zoomSlider.min = caps.zoom.min;
                zoomSlider.max = caps.zoom.max;
                zoomSlider.step = caps.zoom.step;
                zoomSlider.value = settings.zoom || 1;
                zoomCapability = true;

                zoomSlider.oninput = function () {
                    track.applyConstraints({
                        advanced: [{ zoom: parseFloat(this.value) }]
                    });
                }
            }
        } catch (e) { console.log("Camera controls setup error", e); }
    }

    function toggleTorch() {
        if (cameraTrack) {
            const current = cameraTrack.getSettings().torch || false;
            cameraTrack.applyConstraints({
                advanced: [{ torch: !current }]
            }).then(() => {
                const btn = document.getElementById('torch-btn');
                if (btn) {
                    btn.style.color = !current ? '#FFD700' : 'var(--matrix-green)';
                    btn.style.borderColor = !current ? '#FFD700' : 'var(--matrix-green)';
                }
            });
        }
    }

    function updateZoom(value) {
        if (cameraTrack) {
            const zoomValue = parseFloat(value);
            cameraTrack.applyConstraints({
                advanced: [{ zoom: zoomValue }]
            }).then(() => {
                document.getElementById('zoom-level').textContent = zoomValue.toFixed(1) + 'x';
            }).catch(err => {
                console.log('Zoom error:', err);
            });
        }
    }

    function processScannedItem(match) {
        const key = match.seri ? match.seri.seri_no : match.item.stok_kod;

        // Duplicate check
        if (scannedItems.has(key)) {
            return {
                status: 'duplicate',
                msg: `${match.matchCode} zaten tarandı!`
            };
        }

        // Add to scanned items
        const itemData = {
            stok_kod: match.item.stok_kod,
            stok_adi: match.item.stok_adi,
            seri_no: match.seri ? match.seri.seri_no : '-',
            bolge: match.seri ? match.seri.bolge : '-',
            durum: match.seri ? match.seri.durum : 'OK',
            timestamp: new Date().toLocaleTimeString('tr-TR')
        };

        scannedItems.set(key, itemData);

        // Update UI list
        updateScannerList();

        // Update scan count
        document.getElementById('scan-count').textContent = scannedItems.size;

        // Highlight in main table if visible
        highlightScannedRow(match.item.stok_kod);

        return {
            status: 'success',
            msg: `${match.item.stok_kod} - ${match.item.stok_adi}`
        };
    }

    function playBeep(frequency = 1000, duration = 250) {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'square'; // Matrix-style square wave

            // Louder volume: 0.5 instead of 0.3
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        } catch (e) {
            console.log('Beep error:', e);
        }
    }

    function clearScannedItems() {
        if (scannedItems.size === 0) {
            alert('Taranan öğe yok!');
            return;
        }

        if (confirm(`${scannedItems.size} taranan öğeyi temizlemek istediğinizden emin misiniz?`)) {
            scannedItems.clear();
            document.getElementById('scan-count').textContent = '0';

            // Reset list UI
            const list = document.getElementById('scanner-list');
            if (list) {
                list.innerHTML = '<div style="text-align: center; color: #555; font-size: 11px; padding-top: 20px;">Henüz tarama yapılmadı</div>';
            }

            // Remove highlights from table
            document.querySelectorAll('.scanned-item').forEach(row => {
                row.classList.remove('scanned-item');
            });

            alert('Taramalar temizlendi!');
        }
    }

    function updateScannerList() {
        const list = document.getElementById('scanner-list');
        if (!list) return;

        if (scannedItems.size === 0) {
            list.innerHTML = '<div style="text-align: center; color: #555; font-size: 11px; padding-top: 20px;">Henüz tarama yapılmadı</div>';
            return;
        }

        let html = '';
        // Show latest first
        const items = Array.from(scannedItems.values()).reverse();
        items.forEach(item => {
            html += `<div class="scanner-entry">
                <span class="code">${item.stok_kod}</span>
                <span class="name">${item.stok_adi}</span>
                <span class="time">${item.timestamp}</span>
            </div>`;
        });

        list.innerHTML = html;
    }

    function highlightScannedRow(stokKod) {
        // Find and highlight the row in main stock table
        const rows = document.querySelectorAll('#stock-table tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length > 1 && cells[1].textContent.trim() === stokKod) {
                row.classList.add('scanned-item');
            }
        });
    }

    function stopScanner() {
        if (html5QrCode) {
            // Turn off torch if on
            if (cameraTrack) {
                try {
                    cameraTrack.applyConstraints({ advanced: [{ torch: false }] });
                } catch (e) { }
            }

            html5QrCode.stop().then(() => {
                html5QrCode.clear();
            }).catch(err => console.log(err));
        }
        document.getElementById('scanner-modal').style.display = 'none';
        isScanLocked = false;
        cameraTrack = null;
    }

    // PDF İndir
    function downloadPDF() {
        if (scannedItems.size === 0) {
            alert('Önce barkod tarayarak ürün seçin!');
            return;
        }

        // jsPDF yükle
        if (!window.jspdf) {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            script.onload = () => {
                const script2 = document.createElement('script');
                script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js';
                script2.onload = () => generatePDF();
                document.head.appendChild(script2);
            };
            document.head.appendChild(script);
        } else {
            generatePDF();
        }
    }

    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Load Watermark Image
        const img = new Image();
        img.src = '/static/img/yabujin.png';

        img.onload = function () {
            createPDF(doc, img);
        };

        img.onerror = function () {
            console.warn('Logo yuklenemedi, logosuz devam ediliyor.');
            createPDF(doc, null);
        };
    }

    function createPDF(doc, logoImg) {
        // Helper for Turkish Characters (Standard Fonts wrapper)
        // Standard PDF fonts (Courier, Helvetica) don't support full UTF-8. 
        // We map chars to ensure they are readable if the font fails, or rely on browser support.
        function tr(text) {
            if (!text) return '';
            return text.toString()
                .replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
                .replace(/ş/g, 's').replace(/Ş/g, 'S')
                .replace(/ı/g, 'i').replace(/İ/g, 'I') // 'I' is better than nothing
                .replace(/ç/g, 'c').replace(/Ç/g, 'C')
                .replace(/ö/g, 'o').replace(/Ö/g, 'O')
                .replace(/ü/g, 'u').replace(/Ü/g, 'U');
        }

        // --- MATRIX VIBE (Eco-Friendly) ---
        // Font: Courier (Monospaced)
        // Colors: Black text, minimal gray fills (save ink)

        doc.setFont("courier", "bold");
        doc.setFontSize(18);
        doc.setTextColor(0, 0, 0); // Black
        doc.text(tr('RAINSTAFF - STOK ENVANTER RAPORU'), 105, 15, { align: 'center' });

        doc.setFont("courier", "normal");
        doc.setFontSize(10);
        doc.setTextColor(50);
        doc.text(tr(`Tarih: ${new Date().toLocaleString('tr-TR')}`), 14, 25);
        doc.text(tr(`Taranan Oge: ${scannedItems.size} adet`), 14, 30);
        doc.line(14, 33, 196, 33); // Thin line

        // Watermark - Bottom Center (Eco-friendly: Low opacity/Greyscale if possible)
        // Since jsPDF doesn't do transparency easily on images without advanced modes, 
        // we place it at the bottom.
        if (logoImg) {
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const imgWidth = 40; // mm
            const imgHeight = 40; // mm
            const x = (pageWidth - imgWidth) / 2;
            const y = pageHeight - imgHeight - 10;

            try {
                // Add image
                doc.addImage(logoImg, 'PNG', x, y, imgWidth, imgHeight);

                // Add text below
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text("Y A B U J I N   C O R P", pageWidth / 2, y + imgHeight + 5, { align: 'center' });
            } catch (e) {
                console.error("Logo error:", e);
            }
        }

        // Table Data
        const tableData = Array.from(scannedItems.values()).map(item => [
            tr(item.stok_kod),
            tr(item.stok_adi),
            tr(item.seri_no),
            tr(item.bolge),
            tr(item.durum)
        ]);

        // Table Style - Eco Friendly Matrix
        doc.autoTable({
            head: [[tr('Stok Kodu'), tr('Urun Adi'), tr('Seri No'), tr('Bolge'), tr('Durum')]],
            body: tableData,
            startY: 40,
            theme: 'plain', // Save ink! No colored headers
            styles: {
                font: 'courier',
                fontSize: 9,
                cellPadding: 3,
                lineColor: [0, 0, 0], // Black lines
                lineWidth: 0.1,
                textColor: [0, 0, 0] // Black text
            },
            headStyles: {
                fillColor: null, // No fill
                textColor: [0, 0, 0],
                fontStyle: 'bold',
                lineWidth: 0.1,
                lineColor: [0, 0, 0] // Bottom border for header
            },
            alternateRowStyles: {
                fillColor: null // No zebra striping to save ink
            },
            columnStyles: {
                0: { fontStyle: 'bold' } // Stock code bold
            }
        });

        // Save
        const fileName = `stok_raporu_${new Date().toISOString().slice(0, 10)}.pdf`;
        doc.save(fileName);
    }

    // === TEMA SİSTEMİ ===
    const themes = ['matrix', 'cyber', 'light'];
    const themeLabels = {
        'matrix': '[ MATRIX ]',
        'cyber': '[ CYBER ]',
        'light': '[ LIGHT ]'
    };

    function initTheme() {
        const savedTheme = localStorage.getItem('rainstaff-theme') || 'matrix';
        applyTheme(savedTheme);
    }

    function applyTheme(theme) {
        document.body.classList.remove('theme-cyber', 'theme-light');
        if (theme === 'cyber') {
            document.body.classList.add('theme-cyber');
        } else if (theme === 'light') {
            document.body.classList.add('theme-light');
        }
        // Matrix is default, no class needed

        const btn = document.getElementById('theme-toggle');
        if (btn) {
            btn.textContent = themeLabels[theme] || '[ TEMA ]';
        }

        localStorage.setItem('rainstaff-theme', theme);
    }

    function toggleTheme() {
        const currentTheme = localStorage.getItem('rainstaff-theme') || 'matrix';
        const currentIdx = themes.indexOf(currentTheme);
        const nextIdx = (currentIdx + 1) % themes.length;
        applyTheme(themes[nextIdx]);
    }

    // ==============================================
    // ARAÇLAR MODÜLÜ
    // ==============================================

    let vehiclesData = [];

    function loadVehiclesData() {
        const grid = document.getElementById('vehicles-grid');
        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><div class="loading">Araçlar yükleniyor...</div></div>';

        fetch('/api/vehicles')
            .then(res => res.json())
            .then(data => {
                vehiclesData = data;
                renderVehicleCards(data);
                updateVehicleStats(data);
            })
            .catch(err => {
                console.error('Vehicles error:', err);
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #ff4444;">Araç verileri yüklenemedi</div>';
            });
    }

    function updateVehicleStats(data) {
        let critical = 0;
        let warning = 0;
        let normal = 0;

        data.forEach(vehicle => {
            const status = getVehicleStatus(vehicle);
            if (status === 'critical') critical++;
            else if (status === 'warning') warning++;
            else normal++;
        });

        document.getElementById('total-vehicles').textContent = data.length;
        document.getElementById('critical-vehicles').textContent = critical;
        document.getElementById('warning-vehicles').textContent = warning;
        document.getElementById('normal-vehicles').textContent = normal;
    }

    function getVehicleStatus(vehicle) {
        if (!vehicle.alerts || vehicle.alerts.length === 0) return 'normal';

        const hasExpired = vehicle.alerts.some(a => a.status === 'expired');
        const hasCritical = vehicle.alerts.some(a => a.status === 'critical');

        if (hasExpired || hasCritical) return 'critical';

        const hasWarning = vehicle.alerts.some(a => a.status === 'warning');
        if (hasWarning) return 'warning';

        return 'normal';
    }

    function renderVehicleCards(data) {
        const grid = document.getElementById('vehicles-grid');

        if (data.length === 0) {
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">[ SİSTEMDE ARAÇ KAYDI YOK ]</div>';
            return;
        }

        let html = '';
        data.forEach(vehicle => {
            const status = getVehicleStatus(vehicle);
            const borderColor = status === 'critical' ? '#ff4444' : status === 'warning' ? '#FFD700' : 'var(--matrix-green)';
            const glowColor = status === 'critical' ? 'rgba(255, 68, 68, 0.3)' : status === 'warning' ? 'rgba(255, 215, 0, 0.3)' : 'rgba(0, 255, 65, 0.3)';

            // Yağ değişimi progress hesapla
            const oilProgress = calculateOilProgress(vehicle);

            html += `
                <div class="vehicle-card" style="border-color: ${borderColor}; box-shadow: 0 10px 30px ${glowColor};">
                    <div class="vehicle-header">
                        <span class="matrix-bracket">[</span>
                        <span class="vehicle-plate">${vehicle.plate}</span>
                        <span class="matrix-bracket">]</span>
                    </div>
                    
                    <div class="vehicle-info">
                        <div class="info-line">
                            <span class="label">>>> MARKA:</span>
                            <span class="value">${vehicle.brand} ${vehicle.model}</span>
                        </div>
                        <div class="info-line">
                            <span class="label">>>> KM:</span>
                            <span class="value">${vehicle.km.toLocaleString('tr-TR')}</span>
                        </div>
                        <div class="info-line">
                            <span class="label">>>> BÖLGE:</span>
                            <span class="value">${vehicle.region}</span>
                        </div>
                    </div>

                    ${vehicle.alerts && vehicle.alerts.length > 0 ? `
                        <div class="alert-section">
                            ${renderAlerts(vehicle.alerts)}
                        </div>
                    ` : ''}

                    <div class="progress-section">
                        <div class="progress-label">>>> YAĞ DEĞİŞİMİ</div>
                        <div class="matrix-progress">
                            <div class="progress-fill" style="width: ${oilProgress.percent}%; background: ${oilProgress.color};">
                                <div class="progress-glow"></div>
                            </div>
                        </div>
                        <div class="progress-text">${oilProgress.current.toLocaleString('tr-TR')} / ${oilProgress.max.toLocaleString('tr-TR')} KM</div>
                    </div>
                </div>
            `;
        });

        grid.innerHTML = html;
    }

    function calculateOilProgress(vehicle) {
        const current = vehicle.km - vehicle.oil_change_km;
        const max = vehicle.oil_interval_km;
        const percent = Math.min((current / max) * 100, 100);

        let color = 'var(--matrix-green)';
        if (percent >= 90) color = '#ff4444';
        else if (percent >= 70) color = '#FFD700';

        return { current, max, percent, color };
    }

    function renderAlerts(alerts) {
        const alertTypes = {
            'inspection': 'MUAYENE',
            'insurance': 'SİGORTA',
            'maintenance': 'BAKIM'
        };

        return alerts.map(alert => {
            const color = alert.status === 'expired' ? '#ff4444' : alert.status === 'critical' ? '#ff4444' : '#FFD700';
            const icon = alert.status === 'expired' ? '⚠' : alert.status === 'critical' ? '⚠' : '⚡';
            const label = alertTypes[alert.type] || alert.type.toUpperCase();
            const daysText = alert.days < 0 ? `${Math.abs(alert.days)} GÜN GEÇTİ` : `${alert.days} GÜN KALDI`;

            return `
                <div class="alert-item" style="color: ${color}; border-color: ${color};">
                    <span class="alert-icon">${icon}</span>
                    <span class="alert-text">${label}: ${daysText}</span>
                </div>
            `;
        }).join('');
    }

    function initFilters() {
        const now = new Date();
        const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
        const currentYear = String(now.getFullYear());

        // Puantaj filtreleri
        const tsMonth = document.getElementById('ts-month-filter');
        const tsYear = document.getElementById('ts-year-filter');
        if (tsMonth) tsMonth.value = currentMonth;
        if (tsYear) tsYear.value = currentYear;

        // Çalışan filtreleri
        const empMonth = document.getElementById('emp-month-filter');
        const empYear = document.getElementById('emp-year-filter');
        if (empMonth) empMonth.value = currentMonth;
        if (empYear) empYear.value = currentYear;
    }

    // Sayfa yüklenince tema ve filtreleri uygula
    document.addEventListener('DOMContentLoaded', () => {
        initTheme();
        initFilters();

        // === EVENT DELEGATION for Employee Dropdowns ===
        // Attach ONE listener to tbody, handles all rows (current and future)
        const empTbody = document.getElementById('employee-table');
        if (empTbody) {
            empTbody.addEventListener('click', function (e) {
                // Find the clicked row (or parent row if clicked on child element)
                const row = e.target.closest('.employee-toggle');
                if (row) {
                    const index = parseInt(row.dataset.empIndex);
                    if (!isNaN(index)) {
                        toggleEmployee(index);
                    }
                }
            });
        }
    });
</script>
{% endblock %}