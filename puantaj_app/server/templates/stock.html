<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rainstaff Stok Envanteri</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <style>
      .stock-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .stock-item {
        border: 1px solid #333;
        margin-bottom: 8px;
        border-radius: 4px;
        overflow: hidden;
      }

      .stock-item-header {
        background-color: #252525;
        padding: 12px;
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;
      }

      .stock-item-header:hover {
        background-color: #2a2a2a;
      }

      .stock-item-header.open {
        background-color: #2a2a2a;
      }

      .stock-item-toggle {
        color: #FFD700;
        font-weight: bold;
        margin-right: 12px;
        min-width: 20px;
      }

      .stock-item-header-content {
        display: flex;
        gap: 20px;
        flex: 1;
        align-items: center;
      }

      .stock-item-header-left {
        flex: 1;
      }

      .stock-item-code {
        color: #FFD700;
        font-weight: 600;
        font-size: 14px;
      }

      .stock-item-name {
        color: #e0e0e0;
        font-size: 13px;
        margin-top: 2px;
      }

      .stock-item-count {
        color: #888;
        font-size: 12px;
        min-width: 60px;
        text-align: right;
      }

      .stock-item-body {
        display: none;
        background-color: #1f1f1f;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }

      .stock-item-body.open {
        display: block;
        max-height: 2000px;
      }

      .seri-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .seri-item {
        padding: 10px 12px;
        border-bottom: 1px solid #2a2a2a;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #e0e0e0;
      }

      .seri-item:last-child {
        border-bottom: none;
      }

      .seri-no {
        color: #FFD700;
        font-weight: 500;
        min-width: 150px;
      }

      .seri-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 500;
        min-width: 50px;
        text-align: center;
      }

      .seri-status.ok {
        background-color: #2a4a2a;
        color: #6db66d;
      }

      .seri-status.yok {
        background-color: #4a2a2a;
        color: #ff6b6b;
      }

      .seri-status.fazla {
        background-color: #4a4a2a;
        color: #ffeb99;
      }

      .seri-meta {
        color: #888;
        font-size: 12px;
        min-width: 150px;
        text-align: right;
      }

      .search-box {
        margin-bottom: 20px;
      }

      .search-box input {
        width: 100%;
        padding: 10px 12px;
        background-color: #2a2a2a;
        border: 1px solid #444;
        color: #e0e0e0;
        border-radius: 4px;
        font-size: 14px;
      }

      .search-box input::placeholder {
        color: #888;
      }

      .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #888;
        font-size: 14px;
      }
    </style>
  </head>
  <body class="admin">
    <header class="topbar">
      <div class="brand">
        <div>
          <div class="brand-title">Stok Envanteri</div>
          <div class="brand-sub">ÃœrÃ¼n ve seri numaralarÄ±</div>
        </div>
      </div>
      <div class="sync">
        <button class="notify-btn" id="refreshBtn" type="button">Yenile</button>
        <a class="logout" href="/dashboard">Dashboard</a>
      </div>
    </header>

    <div class="layout">
      {% include "_sidebar.html" %}
      <main class="content single">
        <section class="section panel">
          <div class="panel-head">
            <h2>Stok Listesi</h2>
          </div>

          <div class="search-box">
            <input 
              type="text" 
              id="stockSearch" 
              placeholder="Stok No, ÃœrÃ¼n AdÄ± veya Seri No ile ara..."
            />
          </div>

          <ul class="stock-list" id="stockList">
            <li style="text-align: center; padding: 40px 20px; color: #888;">YÃ¼kleniyor...</li>
          </ul>
        </section>
      </main>
    </div>

    <script>
      let stockData = [];

      async function loadStockData() {
        try {
          const response = await fetch('/api/stock-data');
          if (!response.ok) throw new Error('Veri alÄ±namadÄ±');
          
          stockData = await response.json();
          renderStockList();
        } catch (error) {
          console.error('Hata:', error);
          document.getElementById('stockList').innerHTML = 
            '<li style="text-align: center; padding: 40px 20px; color: #ff6b6b;">Hata: ' + error.message + '</li>';
        }
      }

      function renderStockList() {
        const searchTerm = document.getElementById('stockSearch').value.toLowerCase();
        const stockList = document.getElementById('stockList');
        
        let filteredData = stockData;
        
        if (searchTerm) {
          filteredData = stockData.filter(item => 
            item.stok_kod.toLowerCase().includes(searchTerm) ||
            (item.stok_adi && item.stok_adi.toLowerCase().includes(searchTerm)) ||
            item.seri_list.some(s => s.seri_no && s.seri_no.toLowerCase().includes(searchTerm))
          );
        }

        if (filteredData.length === 0) {
          stockList.innerHTML = '<div class="no-results">KayÄ±t bulunamadÄ±</div>';
          return;
        }

        stockList.innerHTML = filteredData.map((item, idx) => `
          <li class="stock-item" data-index="${idx}">
            <div class="stock-item-header" onclick="toggleStock(${idx})">
              <div class="stock-item-header-content">
                <div class="stock-item-toggle">â–¶</div>
                <div class="stock-item-header-left">
                  <div class="stock-item-code">${item.stok_kod}</div>
                  <div class="stock-item-name">${item.stok_adi || '-'}</div>
                </div>
              </div>
              <div class="stock-item-count">${item.seri_count} adet</div>
            </div>
            <div class="stock-item-body" id="body-${idx}">
              <ul class="seri-list">
                ${item.seri_list.map(seri => {
                  const statusClass = seri.durum === 'YOK' ? 'yok' : seri.durum === 'FAZLA' ? 'fazla' : 'ok';
                  return `
                    <li class="seri-item">
                      <div class="seri-no">ðŸ“Œ ${seri.seri_no || '-'}</div>
                      <div class="seri-status ${statusClass}">${seri.durum || 'OK'}</div>
                      <div class="seri-meta">${seri.tarih || '-'} | ${seri.girdi_yapan || '-'}</div>
                    </li>
                  `;
                }).join('')}
              </ul>
            </div>
          </li>
        `).join('');
      }

      function toggleStock(idx) {
        const header = document.querySelector(`[data-index="${idx}"] .stock-item-header`);
        const body = document.getElementById(`body-${idx}`);
        const toggle = header.querySelector('.stock-item-toggle');

        body.classList.toggle('open');
        header.classList.toggle('open');
        toggle.textContent = body.classList.contains('open') ? 'â–¼' : 'â–¶';
      }

      document.getElementById('stockSearch').addEventListener('input', renderStockList);
      document.getElementById('refreshBtn').addEventListener('click', () => {
        document.getElementById('stockList').innerHTML = '<li style="text-align: center; padding: 40px 20px; color: #888;">YÃ¼kleniyor...</li>';
        loadStockData();
      });

      loadStockData();
    </script>
  </body>
</html>
